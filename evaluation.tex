\chapter{Evaluation}\label{ch:Evaluation}

In order to evaluate the effectiveness of the newly developed interpolating intersection logic,
three test cases will be used and compared to the snapshot method.
\newline
The first test case is simple: A receiver moves towards an emitter at 1/9th the speed of sound.
It starts 342.2 meters away from the emitter.
The emitter sends out a sine wave at 440Hz for 1 second.
No other objects are in the scene.
\newline
This is essentially the example described in \ref{im:SnapshotExplain}
and is used to demonstrate the basic differences between interpolated and snapshot methods.
\newline
% TODO image
The second test case takes place inside a rotating rectangular room.
Said room is 4 meters in width and length and 3 meters tall.
The receiver is in the very middle of the room,
with the emitter being 1.2 meters above it.
The room rotates around the Z-axis once per second.
\newline
This is used to test whether the differences between interpolated and snapshot methods
lead to a notable difference in a slightly more practical scenario.
\newline
% TODO image
The third test case takes place inside a rotating L-shaped room,
as denoted in IMAGE, with the receiver being at the origin
and the emitter being 0.5 meters above it.
The room again rotates around the Z-axis, but takes three seconds for a full rotation.
\newline
This case is used to demonstrate the shortcomings of the interpolating intersection logic
and the need for further research for realistic simulations.

\section{Testing Conditions}

Tests were performed on a stock AMD Ryzen 3600xt CPU with 16GB of 3200MHz DDR4 RAM.
All 12 logical cores are used for parallel processing.
\newline
The proof-of-concept used for testing was written in Rust, using the \verb|nalgebra| crate for algebra functions,
\verb|roots| for polynomial solving and \verb|rayon| for parallelisation.
\newline
The first test case with the approaching receiver is run using one ray per sample
as it only attempts to simulate sound travelling from emitter to receiver
without considering bounces from a room around it.
The ray is always directed at the receiver.
\newline
The other two test cases are run using 10 million rays per impulse response,
which is enough to get an approximate \(T_{60}\) accurate to the 10th of a second.
This is sufficient to draw conclusions about the scenes while requiring a reasonable amount of compute time.
To account for variance introduced by randomness, 3 runs are done per simulation method and scene.
\newline
For the two rotating scenes, only one impulse response is calculated and applied to all samples.
This is because the starting condition of a rotating room is always the same:
As both rooms rotate around the emitter's and the receiver's position
and the emitter emits rays randomly in all directions,
the relative position of the room to the receiver and emitter is always the same,
making for the same impulse response at all times.
\newline
Simulations would become much more expensive for scenes where this condition doesn't apply,
as that would mean calculating individual impulse responses for each sample.
For a 1 second sample at 44100 KHz and a roughly 20 minute IR calculation time
(rounded down from the snapshot method test results below),
this would take \(44100 \cdot 20 m = 882000 m = 14700 h = 612.5 d\).
Running simulations for such scenes would require optimisations, much stronger hardware
and/or conceits on ray count to be able to run in a reasonable time.
\newline
All walls in scenes that contain any have a material roughly resembling smooth concrete walls' behaviour for high frequencies.
The absorption coefficient, based on data by acoustic.ua (\url{https://www.acoustic.ua/st/web_absorption_data_eng.pdf}),
is 0.02, meaning that a ray retains 98\% of its energy after bouncing.
Data for diffusion coefficients is not publicly available, so by guesswork, a value of 0.1 was used,
meaning that 90\% of the energy is specularly reflected, while 10\% is diffusely reflected.
In practice, this means that rays have a 10\% chance to bounce in a random direction rather than reflecting off the surface normally.

\section{Approaching Receiver Scene}

In theory, two effects should be observable here.
\newline
Firstly, the ray would take 1 second to arrive at the emitter's position.
As the emitter is travelling towards the ray and covering a tenth of the distance in the time the ray travels the remainder,
the sound should already start at 0.9 seconds.
\newline
Secondly, due to the emitter's fast movement,
the doppler effect would lead to a shift in frequency.
\newline
Using the well-known doppler effect formula with a propagation speed \(c = 342.2 m/s\), an emitter speed \(v_s = 0 m/s\),
a receiver speed \(v_r = 342.2/9 m/s = 38.0\bar{2} m/s\) and a base frequency \(f_0 = 440 Hz\),
the resulting frequency can be calculated as
\begin{equation}\label{eq:Doppler}
    f = \frac{c + v_r}{c + v_s} f_0 = \frac{342.2 m/s + 38.0\bar{2} m/s}{342.2 m/s} \cdot 440Hz = 488.\bar{8} Hz
\end{equation}

% TODO image of sound waves
As expected, the first effect can be observed in the interpolated version of the simulation,
but not in the simulation using the snapshot method.
\newline
This is because for the snapshot method,
only the initial position of the receiver is relevant to the distance a ray needs to travel until it arrives at said receiver.
Thus, the ray has to travel the full 343.2 meters for the initial impulse response, as shown in \ref{im:SnapshotExplain}.
\newline
The interpolated version instead takes this effect into account correctly.
\newline
One notable detail is that the interpolated method also simulates the doppler effect more accurately.
The resulting signal from the interpolated method exactly matches the \(488.\bar{8} Hz\) calculated in \eqref{eq:Doppler},
while the snapshot method instead arrives at a frequency of approximately \(495 Hz\).
% TODO explanation
\newline
% TODO numbers
Performance wise, the simulations barely differ.
This is presumably because each impulse response is calculated using only a single ray
which only needs to check for intersections with a single object,
rendering the increased intersection check costs insignificant.
\newline
Additionally, the snapshot method implementation has the overhead of re-calculating
the chunks for each snapshot scene.
This is insignificant in simulations where many rays are used
as the chunk calculation cost is small by comparison,
but for this single-ray simulation, the overhead evens out the performance gained from having a cheaper intersection calculation.
\newline
A noteworthy implementation detail becomes apparent from the waveform resulting from the simulation:
As the input signal is a single sine wave and the doppler effect would only raise its frequency,
the resulting wave should still be a pure sine wave.
In contrast, the actual result for both simulation types features aliasing effects.
\newline
This is because the simulation is run as the same sample rate as the input signal.
For each input sample, one impulse response is calculated.
As the doppler effect speeds up the incoming signal,
but the sped up signal is not upsampled accordingly,
thus creating the same effect as if the signal was downsampled and stayed at the same frequency.
\newline
To alleviate this, one would need to either run the signal through a low-pass filter ahead of time
or have both the input signal and simulation at a higher sample rate,
then filter and downsample to the target sample rate afterwards.
\newline
The former works, but might damage a signal more complex than a sine wave
and requires knowledge of the scene ahead of time.
For a more complex scene where the downsampling effect cannot be easily calculated prematurely,
this approach becomes unusable.
\newline
The latter leads to increased computation cost as more impulse responses need to be calculated for more signals,
but works with any arbitrary scene.

\section{Rotating Cube Scene}

\begin{table}[t!]\label{tbl:CubeScene}
\centering
    \begin{tabular}{| c | c | c | c | c | c | c |}
        \hline
        Run & Snapshot 1 & Snapshot 2 & Snapshot 3 & Interp. 1 & Interp. 2 & Interp. 3 \\
        \hline
        Time & 0:22:35 & 0:22:21 & 0:22:22 & 4:36:24 & 4:21:59 & TODO \\
        \hline
        \(T_{60}\) & 5.23s & 5.16s & 5.19s & 5.23s & 5.27s & TODO \\
        \hline
    \end{tabular}
    \caption{Rotating Cube Test Results}
\end{table}
% TODO T60s, Performance tables
There is very little audible difference between the snapshot and interpolated version of this scene.
This was to be expected: Since the distance sound travels from wall to wall hardly changes for a rotating scene
and the angle it bounces at becomes insignificant as the reflection becomes more diffuse over time,
the late reverberation in the scene becomes almost the same.
\newline
Still, a minor difference can be observed for the reverberation time \(T_{60}\),
as listed in~\ref{tbl:CubeScene}:
In the interpolated simulation, \(T_{60}\) is slightly higher,
so the reverberation rings out for longer.
\newline
As rays still lose the same amount of energy per bounce
and thus take the same amount of bounces until their energy is depleted,
this implies rays take a longer time between bounces on average,
which in turn means they generally travel a longer distance between bounces.
\newline
This could partially be due to a bounce into a corner,
which would normally make for two bounces off each side of the corner,
becoming a single bounce as the other side of the corner moves out of the way before a ray can reach it.
% TODO potentially investigate further?
\newline
Performance wise, the interpolated method expectedly is much more expensive.
As seen in~\ref{tbl:CubeScene}, the computation time increases roughly tenfold.
This was expected as discussed in \autoref{sec:IntersectionCost}

\section{Rotating L-Shaped Room Scene}

\begin{table}[t!]\label{tbl:LScene}
\centering
    \begin{tabular}{| c | c | c | c | c | c | c |}
        \hline
        Run & Snapshot 1 & Snapshot 2 & Snapshot 3 & Interp. 1 & Interp. 2 & Interp. 3 \\
        \hline
        Time & 0:24:10 & 0:24:11 & 0:23:48 & 7:00:35 & 7:00:56 & 7:00:14 \\
        \hline
        \(T_{60}\) & 5.31s & 4.98s & 4.99s & 5.07s & 5.35 & 5:44 \\
        \hline
    \end{tabular}
    \caption{Rotating L-Shaped Room Test Results}
\end{table}

Note that this scene shows a large limitation of the interpolated simulation as it stands:
% TODO image
As the back surface of the room is rotating in a circle,
it is possible for it to hit a ray while that ray is moving away from it.
This would not happen in the real world as pressure gradients would guide the sound wave away from the wall.
\newline
The behaviour for sound waves getting hit by a wall from behind is thus not defined by physics.
For the sake of this simulation, the rays are discarded as they can't bounce off the wall.
This case can be made less likely by having the room rotate at a slower speed:
The lower the rotation speed, the flatter the angle rays have to bounce off the wall at to be able to then get hit by it from behind.
That solution, however, is antithetical to the goal of this research, which is to simulate rapidly rotating rooms.
